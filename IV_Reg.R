# IV regression package
require('AER')

adj <- matrix(0, 77, 77)
adj[1,2] = 1
adj[1,77] = 1
adj[2,77] = 1
adj[2,1] = 1
adj[2,4] = 1
adj[2,13] = 1
adj[3,77] = 1
adj[3,4] = 1
adj[3,6] = 1 
adj[4,3] = 1
adj[4,2] = 1
adj[4,13] = 1
adj[4,14] = 1
adj[4,77] = 1
adj[4,5] = 1
adj[5,4] = 1
adj[5,6] = 1
adj[5,21] = 1
adj[5,16] = 1
adj[5,22] = 1
adj[6,5] = 1
adj[6,3] = 1
adj[6,7] = 1
adj[4,6] = 1
adj[7,8] = 1
adj[7,22] = 1
adj[7,24] = 1
adj[7,5] = 1
adj[8,7] = 1
adj[8,24] = 1
adj[8,32] = 1
adj[8,28] = 1
adj[9,10] = 1
adj[10,9] = 1
adj[10,11] = 1
adj[10,76] = 1
adj[11,10] = 1
adj[11,12] = 1
adj[11,15] = 1
adj[12, 11] = 1
adj[12,13] = 1
adj[12,15] = 1
adj[12,14] = 1
adj[13,12] = 1
adj[13,14] = 1
adj[13,2] = 1
adj[13,4] = 1
adj[14,13] = 1
adj[14,4] = 1
adj[14,16] = 1
adj[14,12] = 1
adj[15,11] = 1
adj[15,16] = 1
adj[15,17] = 1
adj[15,19] = 1
adj[15,12] = 1
adj[15,14] = 1
adj[16,15] = 1
adj[16,14] = 1
adj[16,20] = 1
adj[16,21] = 1
adj[16,5] = 1
adj[17,76] = 1
adj[17,18] = 1
adj[17,19] = 1
adj[17,15] = 1
adj[18,17] = 1
adj[18,19] = 1
adj[18,25] = 1
adj[19,18] = 1
adj[19,14] = 1
adj[19,15] = 1
adj[19,16] = 1
adj[19,20] = 1
adj[19,25] = 1
adj[20,19] = 1
adj[20,16] = 1
adj[20,21] = 1
adj[20,22] = 1
adj[20,23] = 1
adj[21,20] = 1
adj[21,16] = 1
adj[21,5] = 1
adj[21,22] = 1
adj[21,20] = 1
adj[22,21] = 1
adj[22,5] = 1
adj[22,7] = 1
adj[22,24] = 1
adj[22,23] = 1
adj[22,20] = 1
adj[23,20] = 1
adj[23,22] = 1
adj[23,24] = 1
adj[23,27] = 1
adj[23,26] = 1
adj[23,25] = 1
adj[24,23] = 1
adj[24,22] = 1
adj[24,7] = 1
adj[24,8] = 1
adj[24,28] = 1
adj[25,18] = 1
adj[25,19] = 1
adj[25,20] = 1
adj[25,23] = 1
adj[25,26] = 1
adj[25,29] = 1
adj[26,25] = 1
adj[26,23] = 1
adj[26,27] = 1
adj[26,29] = 1
adj[27,26] = 1
adj[27,23] = 1
adj[27,28] = 1
adj[27,29] = 1
adj[28,27] = 1
adj[28,24] = 1
adj[28,8] = 1
adj[28,32] = 1
adj[28,33] = 1
adj[28,31] = 1
adj[28,29] = 1
adj[28,27] = 1
adj[29,25] = 1
adj[29,26] = 1
adj[29,27] = 1
adj[29,28] = 1
adj[29,30] = 1
adj[29,31] = 1
adj[30,29] = 1
adj[30,31] = 1
adj[30,58] = 1
adj[30,57] = 1
adj[30,56] = 1
adj[31,30] = 1
adj[31,29] = 1
adj[31,28] = 1
adj[31,34] = 1
adj[31,60] = 1
adj[31,59] = 1
adj[32, 8] = 1
adj[32, 33] = 1
adj[32, 28] = 1
adj[33, 32] = 1
adj[33, 34] = 1
adj[33, 35] = 1
adj[33,28] = 1
adj[34,33] = 1
adj[34,35] = 1
adj[34,37] = 1
adj[34,61] = 1
adj[34,60] = 1
adj[34,31] = 1
adj[34,28] = 1
adj[35,33] = 1
adj[35,36] = 1
adj[35,38] = 1
adj[35,34] = 1
adj[36,35] = 1
adj[36,39] = 1
adj[36,38] = 1
adj[37,34] = 1
adj[37,38] = 1
adj[37,40] = 1
adj[37,68] = 1
adj[37,61] = 1
adj[38, 35] = 1
adj[38,36] = 1
adj[38,39] = 1
adj[38,40] = 1
adj[38,37] = 1
adj[39,36] = 1
adj[39,41] = 1
adj[39,38] = 1
adj[40,38] = 1
adj[40,41] = 1
adj[40,42] = 1
adj[40,69] = 1
adj[40,68] = 1
adj[40,37] = 1
adj[41,39] = 1
adj[41,42] = 1
adj[41,40] = 1
adj[42,41] = 1
adj[42,43] = 1
adj[42,69] = 1
adj[42,40] = 1
adj[43,42] = 1
adj[43,46] = 1
adj[43,45] = 1
adj[43,69] = 1
adj[44,69] = 1
adj[44,45] = 1
adj[44,47] = 1
adj[44,49] = 1
adj[44,71] = 1
adj[45,43] = 1
adj[45,46] = 1
adj[45,48] = 1
adj[45,44] = 1
adj[46,45] = 1
adj[46,43] = 1
adj[46,52] = 1
adj[46,48] = 1
adj[47,44] = 1
adj[47,48] = 1
adj[47,50] = 1
adj[48,45] = 1
adj[48,46] = 1
adj[48,51] = 1
adj[48,47] = 1
adj[49,44] = 1
adj[49,50] = 1
adj[49,53] = 1
adj[49,75] = 1
adj[49,73] = 1
adj[49,71] = 1
adj[50,47] = 1
adj[50,51] = 1
adj[50,54] = 1
adj[50,49] = 1
adj[51,50] = 1
adj[51,48] = 1
adj[51,52] = 1
adj[51,55] = 1
adj[51,54] = 1
adj[52,46] = 1
adj[52,55] = 1
adj[52,51] = 1
adj[53,75] = 1
adj[53,49] = 1
adj[53,54] = 1
adj[54,53] = 1
adj[54,50] = 1
adj[54,51] = 1
adj[54,55] = 1
adj[55,51] = 1
adj[55,52] = 1
adj[55,54] = 1
adj[56,64] = 1
adj[56,57] = 1
adj[56,62] = 1
adj[57,56] = 1
adj[57,62] = 1
adj[57,63] = 1
adj[57,58] = 1
adj[58,57] = 1
adj[58,30] = 1
adj[58,59] = 1
adj[58,63] = 1
adj[59,31] = 1
adj[59,50] = 1
adj[59,61] = 1
adj[59,58] = 1
adj[60,31] = 1
adj[60,34] = 1
adj[60,61] = 1
adj[60,59] = 1
adj[61,59] = 1
adj[61,60] = 1
adj[61,37] = 1
adj[61,68] = 1
adj[61,67] = 1
adj[61,63] = 1
adj[61,58] = 1
adj[62,57] = 1
adj[62,63] = 1
adj[62,65] = 1
adj[62,56] = 1
adj[63,58] = 1
adj[63,61] = 1
adj[63,67] = 1
adj[63,66] = 1
adj[63,62] = 1
adj[64,56] = 1
adj[64,65] = 1
adj[65,62] = 1
adj[65,66] = 1
adj[65,70] = 1
adj[66,63] = 1
adj[66,67] = 1
adj[66,70] = 1
adj[66,65] = 1
adj[67,66] = 1
adj[67,63] = 1
adj[67,61] = 1
adj[67,68] = 1
adj[67,71] = 1
adj[68,67] = 1
adj[68,71] = 1
adj[68,61] = 1
adj[68,37] = 1
adj[68,40] = 1
adj[68,69] = 1
adj[69,68] = 1
adj[69,40] = 1
adj[69,42] = 1
adj[69,43] = 1
adj[69,45] = 1
adj[69,44] = 1
adj[69,71] = 1
adj[70,65] = 1
adj[70,66] = 1
adj[70,71] = 1
adj[70,72] = 1
adj[71,70] = 1
adj[71,67] = 1
adj[71,68] = 1
adj[71,69] = 1
adj[71,44] = 1
adj[71,49] = 1
adj[71,73] = 1
adj[71,72] = 1
adj[72,70] = 1
adj[72,71] = 1
adj[72,73] = 1
adj[72,75] = 1
adj[72,74] = 1
adj[73,72] = 1
adj[73,71] = 1
adj[73,49] = 1
adj[73,75] = 1
adj[74,72] = 1
adj[74,75] = 1
adj[75,74] = 1
adj[75,72] = 1
adj[75,73] = 1
adj[75,49] = 1
adj[75,53] = 1
adj[76,10] = 1
adj[76,17] = 1
adj[77,1] = 1
adj[77,2] = 1
adj[77,4] = 1
adj[77,3] = 1

attach(full_dataset)

X <- cbind(Not.Hispanic.or.Latino..White.alone, Not.Hispanic.or.Latino..Asian.alone, Not.Hispanic.or.Latino..Black.or.African.American.alone,  Not.Hispanic.or.Latino..Two.or.More.Races, Hispanic.or.Latino, Median.Age, Total.Households, PERCENT.HOUSEHOLDS.BELOW.POVERTY, PERCENT.AGED.25..WITHOUT.HIGH.SCHOOL.DIPLOMA, PER.CAPITA.INCOME)
#X <- cbind(PC1, PC2, PC3, PC4, PC5, PC6, PC7, PC8, PC9, PC10)
GX <- adj %*% X
G2X <- adj^2 %*% X
Y <- Y_OBSCENITY
GY <- adj %*% Y
G2Y <- adj^2 %*% Y

reg<-ivreg(Y ~ X + GX + GY | X + G2X + G2Y)
summary(reg)

